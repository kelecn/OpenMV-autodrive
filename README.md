# åŸºäºOpenMVçš„æ— äººé©¾é©¶æ™ºèƒ½å°è½¦æ¨¡æ‹Ÿç³»ç»Ÿ
![](https://cdn.jsdelivr.net/gh/kelecn/images@master/post291.png)

**é¡¹ç›®ä½œè€…ï¼š@[kelecn](https://github.com/kelecn)**

If you cannot read Chinese, you can click here:[README-EN](/README-EN.html)

## ä¸€ã€é¡¹ç›®ç®€ä»‹

åŸºäºæœºå™¨è§†è§‰æ¨¡å—OpenMVé‡‡é›†è½¦é“ã€çº¢ç»¿ç¯ã€äº¤é€šæ ‡å¿—ç­‰æ¨¡æ‹Ÿè·¯å†µä¿¡æ¯ï¼Œå®ç°ä¸€è¾†èƒ½è½¦é“ä¿æŒã€çº¢ç»¿ç¯è¯†åˆ«ã€äº¤é€šæ ‡å¿—è¯†åˆ«ã€å®‰å…¨é¿éšœä»¥åŠè¿œç¨‹WiFiæ§åˆ¶çš„å¤šåŠŸèƒ½æ— äººé©¾é©¶å°è½¦ã€‚

**ç¼–ç¨‹è½¯ä»¶ï¼š**

| ç¡¬ä»¶æ¨¡å— | ç¼–ç¨‹è½¯ä»¶                                                     |
| :------: | :----------------------------------------------------------- |
|  OpenMV  | ä½¿ç”¨OpenMVå®˜æ–¹çš„[OpenMV IDE](https://singtown.com/openmv-download/) |
| ESP8266  | ä½¿ç”¨Arduinoå®˜æ–¹çš„[Arduino IDE](https://www.arduino.cc/en/software) |
|  STM32   | ä½¿ç”¨ARMå®˜æ–¹çš„[Keil uVision5](https://www2.keil.com/mdk5)ï¼ˆARMç‰ˆï¼‰ |

**åŠŸèƒ½ä»‹ç»ï¼š**

| ç¡¬ä»¶æ¨¡å— | åŠŸèƒ½å®ç°                                                     |
| :------: | :----------------------------------------------------------- |
|  OpenMV  | ä¸»è¦æ˜¯åˆ©ç”¨OpenMVè¿›è¡Œè·¯å†µä¿¡æ¯ï¼ˆçº¢ç»¿ç¯ã€äº¤é€šæ ‡å¿—ã€è½¦é“ï¼‰çš„é‡‡å–ï¼Œä»¥åŠå’ŒSTM32çš„é€šä¿¡ï¼Œå…·ä½“çœ‹OpenMVæ–‡ä»¶å¤¹ã€‚ |
| ESP8266  | ä¸»è¦æ˜¯åˆ©ç”¨ESP8266ä¸æ‰‹æœºç«¯è¿›è¡Œè¿œç¨‹çš„æŒ‡ä»¤æ¥æ”¶å’Œæ•°æ®äº¤äº’ï¼Œä»¥åŠå’ŒSTM32çš„é€šè®¯ï¼Œå…·ä½“çœ‹ESP8266æ–‡ä»¶å¤¹ã€‚ |
|  STM32   | ä¸»è¦æ˜¯é€šè¿‡ESP8266æ¥æ”¶è¿œç¨‹æ§åˆ¶æŒ‡ä»¤å’Œå¤„ç†è·¯å†µä¿¡æ¯ï¼Œå¹¶æ ¹æ®è¿™äº›æŒ‡ä»¤æ•°æ®è¿›è¡Œå®æ—¶çš„PIDæ§åˆ¶å°è½¦è¿åŠ¨ã€‚å…·ä½“çœ‹STM32æ–‡ä»¶å¤¹ã€‚ |

## äºŒã€ç¡¬ä»¶ç³»ç»Ÿ

æœ¬é¡¹ç›®ã€ŠåŸºäºOpenMVçš„æ— äººé©¾é©¶æ™ºèƒ½å°è½¦æ¨¡æ‹Ÿç³»ç»Ÿã€‹ï¼Œä¸»è¦ä¾é æœºå™¨è§†è§‰æ¨¡å—OpenMVé€šè¿‡å›¾åƒå¤„ç†çš„æ–¹å¼è·å–å®æ—¶çš„è·¯å†µä¿¡æ¯ï¼Œä»¥åŠè¶…å£°æ³¢ä¼ æ„Ÿå™¨è·å–éšœç¢ç‰©è·ç¦»ä¿¡æ¯ï¼Œå¾—åˆ°çš„è·¯å†µæ•°æ®å†é€šè¿‡ä¸²å£ä¼ è¾“åˆ°ä¸»æ§å™¨STM32ä¸Šé¢ï¼ŒSTM32ä¼šå°†å®æ—¶çš„è·¯å†µä¿¡æ¯å¤„ç†æˆæ™ºèƒ½å°è½¦çš„è¿åŠ¨æ§åˆ¶æŒ‡ä»¤ï¼Œè®©æ™ºèƒ½å°è½¦å®ç°çº¢ç»¿ç¯è¯†åˆ«ã€äº¤é€šæ ‡å¿—è¯†åˆ«ä»¥åŠè½¦é“å®æ—¶ä¿æŒçš„åŠŸèƒ½ï¼Œè¿˜æœ‰STM32ä¹Ÿä¼šé€šè¿‡WiFiæ¨¡å—ESP8266ä¸æ‰‹æœºç«¯è¿›è¡Œè·¯å†µæ•°æ®å’Œæ§åˆ¶æŒ‡ä»¤çš„è¿œç¨‹äº¤äº’ã€‚ç¡¬ä»¶ç³»ç»Ÿæ¡†å›¾å¦‚ä¸‹ï¼š

![](https://cdn.jsdelivr.net/gh/kelecn/images@master/post292.png)

ä¸‹é¢ç®€å•ä»‹ç»ä¸€ä¸‹ï¼Œæ•´ä¸ªç³»ç»Ÿç”¨åˆ°çš„ç¡¬ä»¶æ¨¡å—ã€‚

|   ç¡¬ä»¶æ¨¡å—   | å‹å·                                                 |
| :----------: | ---------------------------------------------------- |
|    ä¸»æ§å™¨    | STM32F103ZET6(æ­£ç‚¹åŸå­ç²¾è‹±æ¿F103)                    |
|   è§†è§‰æ¨¡å—   | OpenMV4 H7 PLUSï¼ˆSTM32H750VBT6 +OV7725ï¼‰             |
| è¶…å£°æ³¢ä¼ æ„Ÿå™¨ | HC-SR04                                              |
|   WiFiæ¨¡å—   | ESP8266                                              |
|    æ‰§è¡Œå™¨    | åŒè·¯ H æ¡¥ç”µæœºé©±åŠ¨ã€ç›´æµç”µæœºã€å¼€å‘æ¿è‡ªå¸¦çš„LEDå’Œèœ‚é¸£å™¨ |
|   æ§åˆ¶å¹³å°   | å®‰è£…Blinker APPçš„å®‰å“/è‹¹æœæ‰‹æœº                       |
|     å…¶ä»–     | ç”µæºã€æ¨¡å‹è½¦ã€å¯¼çº¿è‹¥å¹²ç­‰                             |

å…·ä½“çš„ç¡¬ä»¶ç”µè·¯è¿æ¥æ¡†å›¾å¦‚ä¸‹:

![](https://cdn.jsdelivr.net/gh/kelecn/images@master/post293.png)

## ä¸‰ã€è½¯ä»¶ç³»ç»Ÿ

#### 1ã€OpenMVä¸­çš„è·¯å†µè¯†åˆ«ç®—æ³•å®ç°

æœ¬é¡¹ç›®çš„ä¸»è¦è·¯å†µæ•°æ®ä¿¡æ¯éƒ½æ˜¯åŸºäºOpenMVæ‘„åƒå¤´è·å–çš„å›¾åƒè¿›è¡Œå›¾åƒå¤„ç†å¾—åˆ°çš„ã€‚è¦å®ç°æ™ºèƒ½å°è½¦çš„è‡ªåŠ¨é©¾é©¶è¡Œä¸ºï¼Œæœ€èµ·ç è¦è®©å°è½¦è¯†åˆ«åˆ°çº¢ç»¿ç¯ã€äº¤é€šæ ‡å¿—ä»¥åŠè½¦é“ï¼Œåç»­ä¸»æ§å™¨æ‰èƒ½æ ¹æ®è¿™äº›è·¯å†µæ•°æ®ä¿¡æ¯æ§åˆ¶å°è½¦çš„è¿åŠ¨ã€‚å…³äºæœºå™¨è§†è§‰æ¨¡å—OpenMVï¼Œä¹‹å‰æˆ‘åœ¨ã€Š[åˆæ¢æœºå™¨è§†è§‰æ¨¡å—OpenMV](https://kelecn.top/posts/9237/)ã€‹é‡Œé¢å·²ç»ä»‹ç»è¿‡äº†ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚

##### â‘ çº¢ç»¿ç¯è¯†åˆ«

ä¸»è¦æ˜¯å¯¹æ‘„åƒå¤´æ¯å¸§æ‹æ‘„åˆ°çš„å›¾åƒè¿›è¡Œå›¾åƒè¿›è¡Œé˜ˆå€¼å¤„ç†ï¼Œå†è¿›è¡Œåˆ¤æ–­å‡ºç°çš„ç©¶ç«Ÿæ˜¯å“ªç§çº¢ç»¿ç¯ï¼ˆçº¢ç¯ã€ç»¿ç¯ã€é»„ç¯ï¼‰ï¼Œç„¶åå†å°†è¿™ä¸ªåˆ¤å®šç»“æœå’Œå…¶ä»–ä¸¤ä¸ªæ•°æ®ä¸€èµ·æ‰“åŒ…é€šè¿‡ä¸²å£å‘é€å‡ºå»ã€‚

**ã€ç¨‹åºæµç¨‹å›¾ã€‘**

![](https://cdn.jsdelivr.net/gh/kelecn/images@master/post294.png)

**ã€ä¸»è¦ç¨‹åºã€‘**

```python
###################################å¼€å§‹####################################
...
sensor.set_pixformat(sensor.RGB565) # å›¾ç‰‡æ ¼å¼è®¾ä¸º RGB565å½©è‰²å›¾
light_threshold = [(59, 100, 26, 127, -128, 127),(59, 100, -128, -40, -128, 127)]; #è®¾ç½®çº¢ç»¿ç¯é˜ˆå€¼ï¼Œé»˜è®¤ä¸º0æ— çº¢ç»¿ç¯ 1çº¢ç¯ 2ç»¿ç¯ 4é»„ç¯
...
#å®šä¹‰å¯»æ‰¾è‰²å—é¢ç§¯æœ€å¤§çš„å‡½æ•°
def find_max(blobs):    
    max_size=0
    for blob in blobs:
        if blob.pixels() > max_size:
            max_blob=blob
            max_size = blob.pixels()
return max_blob
#ä¸»å¾ªç¯
while(True):
    clock.tick() #è¿½è¸ªä¸¤ä¸ªsnapshots()ä¹‹é—´ç»è¿‡çš„æ¯«ç§’æ•°
    img = sensor.snapshot() #æ‹ä¸€å¼ ç…§ç‰‡ï¼Œè¿”å›å›¾åƒ
    blobs = img.find_blobs(light_threshold,area_threshold=150); #æ‰¾åˆ°çº¢ç»¿ç¯
    cx=0;cy=0;LED_color=0; #å˜é‡å®šä¹‰
    if blobs:
        max_b = find_max(blobs); #å¦‚æœæ‰¾åˆ°äº†ç›®æ ‡é¢œè‰²
        img.draw_rectangle(max_b[0:4]) #åœ¨Blobå‘¨å›´ç»˜åˆ¶ä¸€ä¸ªçŸ©å½¢
        #ç”¨çŸ©å½¢æ ‡è®°å‡ºç›®æ ‡é¢œè‰²åŒºåŸŸ
        img.draw_cross(max_b[5], max_b[6]) # cx, cy
        img.draw_cross(160, 120) # åœ¨ä¸­å¿ƒç‚¹ç”»æ ‡è®°
        #åœ¨ç›®æ ‡é¢œè‰²åŒºåŸŸçš„ä¸­å¿ƒç”»åå­—å½¢æ ‡è®°
        cx=max_b[5];
        cy=max_b[8];
        img.draw_line((160,120,cx,cy), color=(127));
        img.draw_string(cx, cy, "(%d, %d)"%(cx,cy), color=(127));
LED_color=cy; #çº¢ç»¿ç¯çš„é˜ˆå€¼æ˜¯æ•°ç»„é‡Œçš„cyï¼ˆäºŒè¿›åˆ¶ï¼‰ä¸ª
print(LED_color); #ä¸²è¡Œç»ˆç«¯æ‰“å°å‡º çº¢ç»¿ç¯åºå·æ•°æ®
###################################ç»“æŸ####################################
```

##### â‘¡äº¤é€šæ ‡å¿—è¯†åˆ«

ä¸»è¦æ˜¯åˆ©ç”¨NCCï¼ˆNormalized Cross Correlationï¼‰å½’ä¸€åŒ–äº’ç›¸å…³ç®—æ³•æ¥è¿›è¡Œäº¤é€šæ ‡å¿—çš„å›¾åƒè¯†åˆ«ä¸åŒ¹é…ã€‚

**ã€NCCç®—æ³•ã€‘**

NCCç®—æ³•çš„åŸºæœ¬å®ç°åŸç†ï¼šä¸»è¦æ˜¯é€šè¿‡æ±‚ä¸¤å¹…å¤§å°ç›¸è¿‘çš„å›¾åƒçš„ç›¸å…³ç³»æ•°çŸ©é˜µæ¥åˆ¤åˆ«ä¸¤å¹…å›¾åƒæ˜¯å¦ç›¸å…³ã€‚å‡è®¾éœ€è¦è¯†åˆ«çš„åˆå§‹å›¾ç‰‡$g$çš„å¤§å°ä¸º$mÃ—n$ï¼Œæ‘„åƒå¤´æ‹æ‘„åˆ°çš„å›¾ç‰‡Sçš„å¤§å°ä¸º$MÃ—N$ï¼Œå…¶ä¸­çš„ä»¥$(x,y)$ä¸ºå·¦ä¸Šè§’ç‚¹ä¸$g$å¤§å°ç›¸åŒçš„å­å›¾åƒä¸º$S_{(x,y)}$â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹ã€‚å…·ä½“çš„åˆ©ç”¨NCCç®—æ³•å®ç°è®¡ç®—å›¾åƒç›¸ä¼¼åº¦çš„æ–¹æ³•å¦‚ä¸‹ï¼š

$\rho{(x,y)}$â€‹â€‹çš„å®šä¹‰ä¸ºï¼šéšæœºå˜é‡$X$ã€$Y$çš„ç›¸å…³ç³»æ•°

$$
\rho{(x,y)}=\frac{\sigma(S_{x,y},g)}{\sqrt[]{D_{x,y}D}}
$$
  å¼ä¸­ï¼š$\sigma(S_{x,y},g)$â€‹æ˜¯$S_{x,y}$â€‹å’Œ$g$â€‹çš„åæ–¹å·®ï¼›

$D_{x,y}=\frac {1}{mn}\sum_{i=1}^{m} \sum_{j=1}^{n}{(S_{x,y}(i,j)-\overline S_{x,y})^2}$â€‹â€‹ä¸º$S_{x,y}$â€‹â€‹çš„æ–¹å·®ï¼›

$D=\frac {1}{mn}\sum_{i=1}^{m} \sum_{j=1}^{n}{(g(i,j)-\overline g)^2}$â€‹â€‹â€‹ä¸º$g$çš„æ–¹å·®ï¼›

$\overline g$ä¸º$g$çš„ç°åº¦å‡å€¼ï¼›

$\overline S_{x,y}$â€‹â€‹ä¸º$S_{x,y}$â€‹â€‹çš„ç°åº¦å‡å€¼ï¼›

å°†$D_{x,y}$â€‹å’ŒDä»£å…¥$\rho{(x,y)}$â€‹ï¼Œä¼šæœ‰ï¼š

$$
\rho{(x,y)=\frac{ \frac {1}{mn}\sum_{i=1}^{m} \sum_{j=1}^{n}{(S_{x,y}(i,j)-\overline S_{x,y})(g(i,j)-\overline g)}}{\sqrt[]{\frac {1}{mn}\sum_{i=1}^{m} \sum_{j=1}^{n}{(S_{x,y}(i,j)-\overline S_{x,y})^2}}\sqrt[]{\frac {1}{mn}\sum_{i=1}^{m} \sum_{j=1}^{n}{(g(i,j)-\overline g)^2}}}}
$$
å…¶ä¸­ï¼Œç›¸å…³ç³»æ•°$\rho{(x,y)}$æ»¡è¶³ï¼š$\rho{(x,y)\le1}$â€‹ã€‚

$\rho{(x,y)}$è¶Šæ¥è¿‘1ï¼Œè¯´æ˜ä¸¤å¹…å›¾åƒè¶Šæ¥è¿‘ï¼Œä¹Ÿå°±æ˜¯å¤§å›¾åƒçš„å­é›†ä¸­è¶Šæœ‰å¯èƒ½åŒ…å«æœ‰å°å›¾åƒã€‚é€šè¿‡é€‰å–æ°å½“çš„ç›¸å…³ç³»æ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥è®¤ä¸ºï¼Œç›¸å…³ç³»æ•°å¤§äºè¯¥è®¾å®šå€¼çš„å›¾åƒä¸ºæ‰€éœ€è¯†åˆ«çš„å›¾åƒï¼Œä¹Ÿå°±æ˜¯å¯ä»¥å®ç°äº¤é€šæ ‡è¯†çš„è¯†åˆ«ã€‚

**ã€ç¨‹åºæµç¨‹å›¾ã€‘**

![](https://cdn.jsdelivr.net/gh/kelecn/images@master/post295.png)

**ã€ä¸»è¦ç¨‹åºã€‘**

```python
###################################å¼€å§‹####################################
...
sensor.set_pixformat(sensor.GRAYSCALE) #è®¾ç½®å›¾ç‰‡æ ¼å¼ä¸ºç°åº¦å›¾
#å¯¼å…¥å›¾ç‰‡æ¨¡æ¿
template1 = image.Image("/1.pgm") #ç›´è¡Œ
template2 = image.Image("/2.pgm") #å‘å³è½¬å¼¯
template3 = image.Image("/3.pgm") #å‘å·¦è½¬å¼¯
template4 = image.Image("/4.pgm") #åœè½¦è®©è¡Œ
template5 = image.Image("/5.pgm") #é¸£å–‡å­
#ä¸»å¾ªç¯
while (True):
    clock.tick()
    img = sensor.snapshot()
    flag=0
ratio=0
#åŒ¹é…1.pgmï¼ˆç›´è¡Œï¼‰ä¸²è¡Œç»ˆç«¯æ‰“å°goï¼Œflag=1
    r1 = img.find_template(template1, 0.70, step=4, search=SEARCH_EX)
    if r1:
        img.draw_rectangle(r1,color=(255,0,0))
        print("go")
        flag=1
        img.draw_string(10, 10, "%.d"%flag)
#åŒ¹é…2.pgmï¼ˆå‘å³è½¬å¼¯ï¼‰ä¸²è¡Œç»ˆç«¯æ‰“å°rightï¼Œflag=2
    r2 = img.find_template(template2, 0.70, step=4, search=SEARCH_EX) 
    if r2:
        img.draw_rectangle(r2,color=(0,255,0))
        print("right")
        flag=2
        img.draw_string(10, 10, "%.d"%flag)
#åŒ¹é…3.pgmï¼ˆå‘å·¦è½¬å¼¯ï¼‰ä¸²è¡Œç»ˆç«¯æ‰“å°leftï¼Œflag=3
    r3 = img.find_template(template3, 0.70, step=4, search=SEARCH_EX)
    if r3:
        img.draw_rectangle(r3,color=(255,0,0))
        print("left")
        flag=3
        img.draw_string(10, 10, "%.d"%flag)
#åŒ¹é…4.pgmï¼ˆåœè½¦è®©è¡Œï¼‰ä¸²è¡Œç»ˆç«¯æ‰“å°stopï¼Œflag=4
    r4 = img.find_template(template4, 0.70, step=4, search=SEARCH_EX) 
    if r4:
        img.draw_rectangle(r4,color=(255,255,0))
        print("stop")
        flag=4
        img.draw_string(10, 10, "%.d"%flag)
#åŒ¹é…5.pgmï¼ˆé¸£å–‡å­ï¼‰ä¸²è¡Œç»ˆç«¯æ‰“å°beepï¼Œflag=5
    r5 = img.find_template(template5, 0.70, step=4, search=SEARCH_EX)
    if r5:
        img.draw_rectangle(r5,color=(255,255,0))
        print("beep")
        flag=5
        img.draw_string(10, 10, "%.d"%flag)
###################################ç»“æŸ####################################
```

##### â‘¢è½¦é“è¯†åˆ«

 ä¸»è¦é€šè¿‡OpenMVæ¨¡å—ï¼Œè¯†åˆ«å¹¶è·Ÿè¸ªè½¦é“é˜ˆå€¼ï¼Œé€šè¿‡å‡ ä½•è¿ç®—å‡ºå°è½¦ä¸è½¦é“ä¸­çº¿çš„è§’åº¦ï¼ˆåå·¦ä¸ºæ­£ã€åå³ä¸ºè´Ÿï¼‰ï¼Œåé¦ˆå‡ºå°è½¦ä¸è½¦é“çš„çœŸå®åç¦»æƒ…å†µï¼ˆå¯é‡åŒ–ï¼‰ï¼Œåç»­ç”¨äºPIDæ§åˆ¶ã€‚

**ã€ç¨‹åºæµç¨‹å›¾ã€‘**

![](https://cdn.jsdelivr.net/gh/kelecn/images@master/post296.png)

**ã€ä¸»è¦ç¨‹åºã€‘**

```python
###################################å¼€å§‹####################################
...
sensor.set_pixformat(sensor.RGB565) # å›¾ç‰‡æ ¼å¼è®¾ä¸º RGB565å½©è‰²å›¾
road_threshold = [(23, 0, -45, 19, -31, 28)]; #é»‘çº¿é“è·¯
ROI = (0, 100, 320, 40)
...
#çœç•¥äº†è¯†åˆ«è½¦é“è¾¹æ¡†å‡½æ•°
#åç§»è§’åº¦è®¡ç®—ç®—æ³•
def get_direction(left_blob, right_blob):
    # æ ¹æ®å›¾åƒä¸­çš„ä¸‰å—å·¦ä¸­å³çš„ç™½è‰²éƒ¨åˆ†ï¼Œè®¡ç®—å‡ºæ‘„åƒå¤´åè½¬è§’åº¦
    # ratio < 0 å·¦æ‹ï¼Œå°è½¦åœ¨è½¦é“åå³ä½ç½®
    # ratio > 0 å³æ‹ï¼Œå°è½¦åœ¨è½¦é“åå·¦ä½ç½®

    MAX_WIDTH = 320
    # è°ƒèŠ‚thetaæ¥è®¾ç½®ä¸­é—´å®½åº¦çš„æ¯”é‡ï¼Œ thetaè¶Šé«˜ratioè¶Šé è¿‘0
    # éœ€è¦æ ¹æ®èµ›é“å®½åº¦ä¸æ‘„åƒå¤´é«˜åº¦é‡æ–°è®¾å®šåˆ°åˆé€‚å¤§å°
    theta = 0.01
    # è¿™é‡Œçš„bæ˜¯ä¸ºäº†é˜²æ­¢é™¤æ•°æ˜¯0çš„æƒ…å†µå‘ç”Ÿï¼Œ è®¾å®šä¸€ä¸ªå°ä¸€ç‚¹çš„å€¼
    b = 3
    x1 = left_blob.x() - int(0.5 * left_blob.w()) #å·¦è¾¹é»‘çº¿ä¸­å¿ƒxå€¼
    x2 = right_blob.x() + int(0.5 * right_blob.w()) #å³è¾¹é»‘çº¿ä¸­å¿ƒxå€¼
#è½¦é“ä¿¡æ¯è®¡ç®—
    w_left = x1 #å·¦è¾¹è½¦é“å¤–å®½åº¦
    w_center = math.fabs(x2 - x1) #è½¦é“ä¸­å¿ƒxå€¼
    w_right = math.fabs(MAX_WIDTH - x2) #å³è¾¹è½¦é“å¤–å®½åº¦
#è®¡ç®—æ‘„åƒå¤´åç§»è§’åº¦
    direct_ratio = (w_left + b + theta * w_center) / (w_left + w_right + 2 * b + 2 * theta * w_center) - 0.5
#è¿”å›æ‘„åƒå¤´åç§»è§’åº¦
return direct_ratio
#çœç•¥äº†å¯è§†åŒ–ç»˜å›¾å‡½æ•°
...
while(True): #ä¸»å¾ªç¯
clock.tick() #è¿½è¸ªä¸¤ä¸ªsnapshots()ä¹‹é—´ç»è¿‡çš„æ¯«ç§’æ•°
    img = sensor.snapshot() #æ‹ä¸€å¼ ç…§ç‰‡ï¼Œè¿”å›å›¾åƒ
    blobs = img.find_blobs(road_threshold, roi=ROI, merge=True);
    a=0;ratio=0;
    if blobs:
        left_blob, right_blob = get_top2_blobs(blobs)

        if(left_blob == None or right_blob == None):
            print("Out Of Range")
            continue
        else:
#ç”»å‡ºè½¦é“å·¦è¾¹çº¿
            img.draw_rectangle(left_blob.rect())
            img.draw_cross(left_blob.cx(), left_blob.cy())
#ç”»å‡ºè½¦é“å³è¾¹çº¿
            img.draw_rectangle(right_blob.rect())
            img.draw_cross(right_blob.cx(), right_blob.cy())
#å¯è§†åŒ–æ˜¾ç¤ºåè½¬è§’åº¦
            direct_ratio = get_direction(left_blob, right_blob)
            draw_direct(img,direct_ratio)
            ratio=int(math.degrees(direct_ratio)) #åè½¬è§’åº¦è½¬æˆå¼§åº¦å€¼
            img.draw_string(10, 10, "%.d"%ratio) #å¸§ç¼“å†²åŒºå®æ—¶ç”»å‡ºåè½¬è§’åº¦
            print(ratio) #ä¸²è¡Œç»ˆç«¯æ‰“å°åè½¬è§’åº¦
    img.draw_rectangle(ROI,color=(255, 0, 0)) #ç”»å‡ºæ„Ÿå…´è¶£åŒºåŸŸ
###################################ç»“æŸ####################################
```

#### 2ã€åŸºäºESP8266çš„è¿œç¨‹æ§åˆ¶å¹³å°å®ç°

ä¸»è¦æ˜¯åˆ©ç”¨ç‚¹ç¯ç§‘æŠ€-[Blinker](https://diandeng.tech/home)ç‰©è”ç½‘å¹³å°æ­å»ºæ§åˆ¶APPçš„UIç•Œé¢ï¼Œä»¥åŠè°ƒç”¨Blinkerçš„æ§åˆ¶ä»£ç ï¼Œå®ç°æ™ºèƒ½å°è½¦æ§åˆ¶æŒ‡ä»¤çš„ä¸‹å‘ä¸è·¯å†µæ•°æ®çš„ä¸Šä¼ ã€‚

**ã€è¿œç¨‹æ§åˆ¶å¹³å°UIç•Œé¢ã€‘**

<img src="https://cdn.jsdelivr.net/gh/kelecn/images@master/post297.png" style="zoom: 25%;" />

**ã€UIé…ç½®ä»£ç ã€‘**

ç›´æ¥ä½¿ç”¨ [ç‚¹ç¯.blinker](https://www.diandeng.tech/home) APPå¯¼å…¥é…ç½®ä»£ç å³å¯è·å¾—å’Œæˆ‘ä¸€æ ·çš„UIå¸ƒå±€ã€‚

```
{Â¨configÂ¨{Â¨headerColorÂ¨Â¨transparentÂ¨Â¨headerStyleÂ¨Â¨darkÂ¨Â¨backgroundÂ¨{Â¨imgÂ¨Â¨assets/img/headerbg.jpgÂ¨Â¨isFullÂ¨Â«}}Â¨dashboardÂ¨|{Â¨typeÂ¨Â¨btnÂ¨Â¨icoÂ¨Â¨fad fa-arrow-alt-upÂ¨Â¨modeÂ¨Ã‰Â¨t0Â¨Â¨å‰è¿›Â¨Â¨t1Â¨Â¨æ–‡æœ¬2Â¨Â¨bgÂ¨ÃŒÂ¨colsÂ¨Ã‹Â¨rowsÂ¨Ã‹Â¨keyÂ¨Â¨btn-goÂ¨Â´xÂ´ÃŒÂ´yÂ´ÃÂ¨speechÂ¨|Ã·Â¨clrÂ¨Â¨#076EEFÂ¨}{ÃŸAÃŸBÃŸCÂ¨fad fa-arrow-alt-downÂ¨ÃŸEÃ‰ÃŸFÂ¨åé€€Â¨ÃŸHÃŸIÃŸJÃŒÃŸKÃ‹ÃŸLÃ‹ÃŸMÂ¨btn-backÂ¨Â´xÂ´ÃŒÂ´yÂ´Â¤CÃŸO|Ã·ÃŸPÃŸQÂ¨lstyleÂ¨Ã‰}{ÃŸAÃŸBÃŸCÂ¨fad fa-arrow-alt-rightÂ¨ÃŸEÃ‰ÃŸFÂ¨å³è½¬Â¨ÃŸHÃŸIÃŸJÃŒÃŸKÃ‹ÃŸLÃ‹ÃŸMÂ¨btn-rightÂ¨Â´xÂ´ÃÂ´yÂ´Ã’ÃŸO|Ã·ÃŸPÃŸQÃŸUÃ‰}{ÃŸAÃŸBÃŸCÂ¨fad fa-arrow-alt-leftÂ¨ÃŸEÃ‰ÃŸFÂ¨å·¦è½¬Â¨ÃŸHÃŸIÃŸJÃŒÃŸKÃ‹ÃŸLÃ‹ÃŸMÂ¨btn-leftÂ¨Â´xÂ´Ã‰Â´yÂ´Ã’ÃŸO|Ã·ÃŸPÃŸQÃŸUÃ‰}{ÃŸAÃŸBÃŸCÂ¨fad fa-power-offÂ¨ÃŸEÃ‰ÃŸFÂ¨åœè½¦Â¨ÃŸHÃŸIÃŸJÃŒÃŸKÃ‹ÃŸLÃ‹ÃŸMÂ¨btn-stopingÂ¨Â´xÂ´ÃÂ´yÂ´ÃÃŸO|Ã·ÃŸPÃŸQÃŸUÃ‰}{ÃŸAÂ¨texÂ¨ÃŸFÂ¨ğŸ˜‹å°è½¦è¿œç¨‹ç›‘æ§ç³»ç»ŸğŸ˜‹Â¨ÃŸHÂ´Â´ÃŸJÃ‹ÃŸCÂ´Â´ÃŸKÃÃŸLÃŠÃŸMÂ´Â´Â´xÂ´Ã‹Â´yÂ´Ã‹ÃŸO|Ã·ÃŸPÃŸQÃŸUÃŠ}{ÃŸAÂ¨numÂ¨ÃŸFÂ¨éšœç¢ç‰©è·ç¦»Â¨ÃŸCÂ¨fad fa-routeÂ¨ÃŸPÃŸQÂ¨minÂ¨Ã‰Â¨maxÂ¨Â¢1cÂ¨uniÂ¨Â¨cmÂ¨ÃŸJÃ‰ÃŸKÃÃŸLÃ‹ÃŸMÂ¨num-distanceÂ¨Â´xÂ´Ã‰Â´yÂ´Â¤EÃŸO|Ã·ÃŸUÃŠ}{ÃŸAÃŸgÃŸFÂ¨å°è½¦åç§»è§’åº¦Â¨ÃŸCÂ¨fad fa-tachometer-alt-fastÂ¨ÃŸPÃŸQÃŸjÃ‰ÃŸkÂº0ÃŸlÂ´ÂºÂ´ÃŸJÃ‰ÃŸKÃÃŸLÃ‹ÃŸMÂ¨num-angleÂ¨Â´xÂ´ÃÂ´yÂ´Â¤EÃŸO|Ã·ÃŸUÃŠ}{ÃŸAÃŸgÃŸFÂ¨çº¢ç»¿ç¯(çº¢1ç»¿2)Â¨ÃŸCÂ¨fad fa-siren-onÂ¨ÃŸPÃŸQÃŸjÃ‰ÃŸkÃ‹ÃŸlÂ´Â´ÃŸJÃ‰ÃŸKÃ‹ÃŸLÃ‹ÃŸMÂ¨num-ledÂ¨Â´xÂ´Ã‰Â´yÂ´ÃÃŸO|Ã·ÃŸUÃ‰}{ÃŸAÂ¨debÂ¨ÃŸEÃ‰ÃŸJÃ‰ÃŸKÃ‘ÃŸLÃŒÃŸMÂ¨debugÂ¨Â´xÂ´Ã‰Â´yÂ´ÃŒÃŸO|Ã·ÃŸUÃ‰}{ÃŸAÃŸgÃŸFÂ¨WIFIä¿¡å·Â¨ÃŸCÂ¨fad fa-signal-4Â¨ÃŸPÂ¨#389BEEÂ¨ÃŸjÃ‰ÃŸkÂº0ÃŸlÂ¨dbmÂ¨ÃŸJÃ‰ÃŸKÃ‹ÃŸLÃ‹ÃŸMÂ¨num-wifiÂ¨Â´xÂ´ÃÂ´yÂ´Ã‰ÃŸO|Ã·ÃŸUÃ‰}{ÃŸAÃŸBÃŸCÂ¨fad fa-repeat-altÂ¨ÃŸEÃŠÃŸFÂ¨è‡ªåŠ¨é©¾é©¶æ¨¡å¼Â¨ÃŸHÃŸIÃŸJÃ‹ÃŸKÃ‹ÃŸLÃ‹ÃŸMÂ¨btn-autoÂ¨Â´xÂ´ÃŒÂ´yÂ´Ã’ÃŸO|Ã·ÃŸPÃŸQÃŸUÃ‰}Ã·Â¨actionsÂ¨|Â¦Â¨cmdÂ¨Â¦Â¨switchÂ¨â€¡Â¨textÂ¨â€¡Â´onÂ´Â¨æ‰“å¼€?nameÂ¨Â¨offÂ¨Â¨å…³é—­?nameÂ¨â€”Ã·Â¨triggersÂ¨|{Â¨sourceÂ¨ÃŸ16Â¨source_zhÂ¨Â¨å¼€å…³çŠ¶æ€Â¨Â¨stateÂ¨|Â´onÂ´ÃŸ19Ã·Â¨state_zhÂ¨|Â´æ‰“å¼€Â´Â´å…³é—­Â´Ã·}Ã·}
```

**ã€æ§åˆ¶æŒ‡ä»¤ä¸ç›‘æ§æ•°æ®ã€‘**

| åç§°         | åŠŸèƒ½æŒ‰é’®/æ•°æ®æ¥æ”¶æ¡†çš„åŠŸèƒ½       | æ•°æ®é”®å     | æŒ‡ä»¤ |
| ------------ | ------------------------------- | ------------ | ---- |
| WiFiä¿¡å·     | æ¥æ”¶WiFiä¿¡å·æ•°æ®                | num-wifi     | â€”    |
| çº¢ç»¿ç¯æ•°æ®   | æ¥æ”¶çº¢ç»¿ç¯æ•°æ®ï¼ˆæ— 0ï¼Œçº¢1ï¼Œç»¿2ï¼‰ | num-led      | â€”    |
| å°è½¦åç§»è§’åº¦ | æ¥æ”¶å°è½¦åç§»è§’åº¦                | num-angle    | â€”    |
| éšœç¢ç‰©è·ç¦»   | æ¥æ”¶éšœç¢ç‰©è·ç¦»æ•°æ®              | num-distance | â€”    |
| åœè½¦         | å‘å‡ºåœè½¦æŒ‡ä»¤                    | btn-stoping  | 0    |
| å‰è¿›         | å‘å‡ºå‰è¿›æŒ‡ä»¤                    | btn-go       | 1    |
| å³è½¬         | å‘å‡ºå³è½¬æŒ‡ä»¤                    | btn-right    | 2    |
| å·¦è½¬         | å‘å‡ºå·¦è½¬æŒ‡ä»¤                    | btn-left     | 3    |
| åé€€         | å‘å‡ºåé€€æŒ‡ä»¤                    | btn-back     | 4    |
| è‡ªåŠ¨é©¾é©¶     | å‘å‡ºè‡ªåŠ¨é©¾é©¶æŒ‡ä»¤                | btn-auto     | 5    |
| Debug        | æ˜¾ç¤ºæ”¶å‘æ•°æ®çš„åŸå§‹æ•°æ®æ ¼å¼      | â€”            | â€”    |

**ã€ç¨‹åºæµç¨‹å›¾ã€‘**

![](https://cdn.jsdelivr.net/gh/kelecn/images@master/post298.png)

**ã€ä¸»è¦ç¨‹åºã€‘**

```c
/***********************************å¼€å§‹***********************************/
...
int  flag= 0;                        //æŒ‰é”®æ ‡å¿—ä½
int  l= 0;                          //çº¢ç»¿ç¯æ•°æ®
int  a= 0;                         //è§’åº¦æ•°æ®
int  d= 0;                        //è·ç¦»æ•°æ®
int  z= 0;                        //jsonè§£æå‡ºæ¥çš„æ•°æ®
BlinkerNumber Number0("num-wifi");//WIFIä¿¡å·
BlinkerNumber Number1("num-led");//çº¢ç»¿ç¯ä¿¡å·
BlinkerNumber Number2("num-angle");//è§’åº¦ä¿¡å·
BlinkerNumber Number3("num-distance");//è·ç¦»ä¿¡å·
BlinkerButton Button0("btn-stoping");//åœæ­¢çŠ¶æ€æŒ‰é”®
BlinkerButton Button1("btn-go");//å‰è¿›çŠ¶æ€æŒ‰é”®
BlinkerButton Button2("btn-right");//å³è½¬çŠ¶æ€æŒ‰é”®
BlinkerButton Button3("btn-left");//å·¦è½¬çŠ¶æ€æŒ‰é”®
BlinkerButton Button4("btn-back");//åé€€çŠ¶æ€æŒ‰é”®
BlinkerButton Button5("btn-auto");//è‡ªåŠ¨é©¾é©¶çŠ¶æ€æŒ‰é”®
...
/*ä¸»å¾ªç¯*/
void loop()
{
    Blinker.run();
    Number0.print(WiFi.RSSI());  //å‘é€ä¿¡å·å¼ºåº¦
    usartEvent();//ä¸²å£ä¸­æ–­
    l=int(z/10000);          //è§£æçº¢ç»¿ç¯æ•°æ®
    a=int((z-10000*l)/100);  //è§£æåç§»è§’åº¦æ•°æ®
d=int(z-10000*l-100*a); //è§£æè·ç¦»æ•°æ®
    Number1.print(l);  //å‘é€çº¢ç»¿ç¯ä¿¡å·
    Number2.print(a);  //å‘é€è§’åº¦ä¿¡å·
    Number3.print(d);  //å‘é€è·ç¦»ä¿¡å·
//å‘é€æ§åˆ¶æŒ‡ä»¤ï¼Œç¯çš„äº®ç­ï¼Œä¸»è¦æ˜¯æ£€æŸ¥WiFiæ¨¡å—æ˜¯å¦æ¥æ”¶åˆ°æ•°æ®
    if(oState == false && digitalRead(LED_BUILTIN)== LOW)//ç¯ç­
    {
      digitalWrite(LED_BUILTIN,HIGH);//ç¯ç­
      Serial.print(flag);                //å‘é€æŒ‡ä»¤
    }
     else if(oState == true && digitalRead(LED_BUILTIN)== HIGH)//ç¯äº®
     {
       digitalWrite(LED_BUILTIN,LOW);//ç¯äº®
       Serial.print(flag);                 //å‘é€æŒ‡ä»¤
     }
}
//Blinkeråˆå§‹åŒ–ç•¥
//WiFiè¿æ¥ä¿¡å·æ£€æµ‹ç•¥
//STM32æ•°æ®ä¸Šä¼ è§£æç•¥
...
/***********************************ç»“æŸ***********************************/
```

#### 3ã€æ™ºèƒ½å°è½¦çš„æ— äººæ§åˆ¶æ–¹æ¡ˆå®ç°

æ™ºèƒ½å°è½¦åœ¨æ¥æ”¶åˆ°ESP8266çš„æ§åˆ¶æŒ‡ä»¤å’ŒOpenMVè·¯å†µæ•°æ®ï¼Œä¼šæ ¹æ®è¿™äº›æŒ‡ä»¤æ•°æ®è¿›è¡Œå°è½¦è¿åŠ¨çš„æ§åˆ¶ã€‚

**ã€ç¨‹åºæµç¨‹å›¾ã€‘**

![](https://cdn.jsdelivr.net/gh/kelecn/images@master/post299.png)

**ã€PIDæ§åˆ¶ç®—æ³•ã€‘**

å…³äºç›´æµç”µæœºçš„PIDè°ƒèŠ‚ï¼Œä¸»è¦ç”¨æ¥å®ç°è½¦é“ä¿æŒåŠŸèƒ½ã€‚é€šè¿‡OpenMVè¿”å›çš„åè½¬è§’åº¦ï¼Œè¿›è¡Œå®æ—¶è°ƒèŠ‚ç”µæœºPWMè¾“å‡ºï¼Œä½¿å¾—åè½¬è§’åº¦$Y=50$â€‹ï¼ˆä¹Ÿå°±æ˜¯å°è½¦ä¸ä¸­çº¿çš„åè½¬è§’ä¸º0ï¼Œç”±äºä¹‹å‰ä¸ºäº†ä¼ è¾“æ–¹ä¾¿æ•´ä½“åŠ ä¸Šäº†50ï¼‰ã€‚æ•…å°†è®¾å®šå€¼å®šä¸º50ï¼Œé€šè¿‡å®æ—¶è¿”å›çš„$Y$å€¼ä¸50åšå·®å€¼è¿ç®—ï¼Œå¾—åˆ°PIDçš„è¾“å…¥åå·®ï¼Œé€šè¿‡ä½ç½®å¼PIDè¿”å›å®æ—¶çš„PWMå€¼ã€‚å…³äº[PIDæ§åˆ¶ç®—æ³•](https://kelecn.top/posts/16358/)ï¼Œä¹‹å‰ä¹Ÿæœ‰ä»‹ç»åˆ°ï¼Œè¿™é‡Œä¸å†æ·±å…¥èµ˜è¿°ã€‚
$$
PWM=K_P\theta(t)+K_i\sum_{t=0}\theta(t)+K_d[\theta(t)-\theta(t-1)]
$$
å…¶ä¸­ä¸º$\theta(t)$â€‹â€‹æ˜¯æœ¬æ¬¡OpenMVè¿”å›çš„åç§»è§’åº¦æ•°æ®$Y$â€‹â€‹ä¸50çš„å·®å€¼ï¼Œ$\theta(t-1)$â€‹â€‹ä¸ºä¸Šä¸€ä¸ª$Y$â€‹â€‹â€‹ä¸50çš„å·®å€¼ã€‚

![](https://cdn.jsdelivr.net/gh/kelecn/images@master/post299-1.png)

 **ã€æ¨¡æ‹Ÿç¯å¢ƒã€‘**

<img src="https://cdn.jsdelivr.net/gh/kelecn/images@master/post299-2.png" style="zoom: 33%;" />

**ã€ä¸»è¦ç¨‹åºã€‘**

ç•¥ï¼Œè¯¦çœ‹ï¼š[OpenMV-autodrive](https://github.com/kelecn/OpenMV-autodrive)

